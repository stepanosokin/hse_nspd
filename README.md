### Общее описание
Скрипт hse_nspd.py предназначен для выгрузки данных из WMS-сервисов НСПД (nspd.gov.ru/map).
Основа работы скрипта - получение координат и атрибутов пространственных объектов через
запросы GetFeatureInfo и сохранение результатов в формат GeoJSON. Запросы GetFeatureInfo выполняются по предрасчитанным тайлам, а внутри каждого тайла попиксельно.

### Что понадобится
Для использования скрипта необходимо:
1) любой редактор кода, рекомендуется VSCode;
2) рекомендуется утилита uv для управления окружением Python;
3) знать, какой слой с портала НСПД вам нужен, и его идентификатор;
4) Часть слоев на НСПД доступны только после логина через Госуслуги. Для загрузки таких слоев потребуется залогиниться через сайт,
   и впоследствии использованная учетная запись может быть проидентифицирована со стороны НСПД.

### Инструкции по использованию
1) git clone https://github.com/stepanosokin/hse_nspd.git
2) (рекомендуется) установить uv https://docs.astral.sh/uv/getting-started/installation/
3) открыть в VSCode папку проекта hse_nspd. Открыть файл hse_nspd.py. Скачивание данных происходит путем запуска этого скрипта. Пролистать в низ файла.
4) Открыть терминал Ctrl+Shift+`. Для синхронизации окружения Python выполнить команду. 
   ```
   uv sync
   ```
    Произойдет загрузка библиотек в соответствии с файлом pyproject.toml.
5) Определиться, какие слои НСПД вам нужны, и записать их идентификаторы. Чтобы это сделать, можно или использовать слои из списка nspd_layers (строка 208), или определить их самостоятельно:
   1) зайти на сайт nspd.gov.ru/map через Google Chrome
   2) залогиниться, если надо
   3) открыть devtools
   4) включить нужный слой
   5) в devtools в разделе Network внизу найти любой запрос GetMap. Выделить его. Во вкладке Headers вверху будет URL вида https://nspd.gov.ru/api/aeggis/v3/848579/wms?REQUEST=GetMap&SERVICE=WMS&VERSION=... В данном случае идентификатор слоя 848579. Записать нужные идентификаторы.
6) Подготовить Geoackage со слоем, содержащим тайлы, по которым будет происходить парсинг. Удобно использовать QGIS и инструмент Create grid. Рекомендуемый размер тайлов 78271.517000 x 78271.517000 м. Проекция EPSG:3857. Тайлы должны покрывать всю территорию парсинга. Geopackage сохранить в папку проекта.
7) Создать в папке проекта папку results.
8) Определить начальные значения ключа доступа (access_token), ключа обновления (refresh_token) и срока действия ключа доступа (auth_access_token_expires). Заменить ими значения соответствующих переменных в строках 233-235. Для этого:
   1) аналогично предыдущему шагу, найти любой из запросов GetMap. В Разделе Request Headers будет Cookie. Из него и надо взять значения. access_token - это параметр authAccessToken, refresh_token - это параметр authRefreshToken, auth_access_token_expires - это параметр authAccessTokenExpires. Пример cookie:
   ```
   _ym_uid=1756110247627323266; _ym_d=1756110247; _ym_isad=1;authAccessToken=eyJhbGci<тут длинющая строка>; authAccessTokenExpires=%222025-08-25T10%3A01%3A11.688Z%22;authRefreshToken=c7M8ixRGrknyW4xuDAkcQxRdWbhluEvR6Qf7Ki70aL2ALxLyaJqfj0p3knOQOqu4o7w1ZZeAQRNQrafJy5
   ```
   Здесь: 
   ```
   access_token = 'eyJhbGci<тут длинющая строка>'
   refresh_token = 'c7M8ixRGrknyW4xuDAkcQxRdWbhluEvR6Qf7Ki70aL2ALxLyaJqfj0'
   auth_access_token_expires = '%222025-08-25T10%3A01%3A11.688Z%22'
   ```
