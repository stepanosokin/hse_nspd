### Общее описание
Скрипт hse_nspd.py предназначен для выгрузки данных из WMS-сервисов НСПД (nspd.gov.ru/map).
Основа работы скрипта - получение координат и атрибутов пространственных объектов через
запросы GetFeatureInfo и сохранение результатов в формат GeoJSON в проекции EPSG:3857. Запросы GetFeatureInfo выполняются по предрасчитанным тайлам, а внутри каждого тайла попиксельно.

### Что понадобится
Для использования скрипта необходимо:
1) любой редактор кода, рекомендуется VSCode;
2) рекомендуется утилита uv для управления окружением Python;
3) знать, какой слой с портала НСПД вам нужен, и его идентификатор;
4) Часть слоев на НСПД доступны только после логина через Госуслуги. Для загрузки таких слоев потребуется залогиниться через сайт, и впоследствии использованная учетная запись может быть проидентифицирована со стороны НСПД.
5) потребуются начальные значения ключа доступа, ключа обновления и срока действия ключа доступа. Откуда их взять - см.ниже.

### Инструкции по использованию
1) git clone https://github.com/stepanosokin/hse_nspd.git
2) (рекомендуется) установить uv https://docs.astral.sh/uv/getting-started/installation/
3) открыть в VSCode папку проекта hse_nspd. Открыть файл hse_nspd.py. Скачивание данных происходит путем запуска этого скрипта. Пролистать в низ файла.
4) Открыть терминал Ctrl+Shift+`. Для синхронизации окружения Python выполнить команду. 
   ```
   uv sync
   ```
    Произойдет загрузка библиотек в соответствии с файлом pyproject.toml.
5) Убедиться, что среда использует Python-окружение из папки .venv внутри проекта. В VSCode это можно сделать через
```Ctrl+Shift+P```
```> Python: Select Interpreter```
и выбрать окружение в локальной папке .venv в папке проекта

1) Определиться, какие слои НСПД вам нужны, и записать их идентификаторы. Чтобы это сделать, можно или использовать слои из списка nspd_layers (строка 208), или определить их самостоятельно:
   1) зайти на сайт nspd.gov.ru/map через Google Chrome
   2) залогиниться, если надо
   3) открыть devtools
   4) включить нужный слой
   5) в devtools в разделе Network внизу найти последний запрос GetMap. Выделить его. Во вкладке Headers вверху будет URL вида https://nspd.gov.ru/api/aeggis/v3/848579/wms?REQUEST=GetMap&SERVICE=WMS&VERSION=... В данном случае идентификатор слоя 848579. Записать нужные идентификаторы.
2) Подготовить Geopackage со слоем, содержащим тайлы, по которым будет происходить парсинг. Удобно использовать QGIS и инструмент Create grid. Рекомендуемый размер тайлов 78271.517 x 78271.517 м. Проекция EPSG:3857. Тайлы должны покрывать всю территорию парсинга. Geopackage сохранить в папку проекта.
3) Создать в папке проекта папку results.
4) Определить начальные значения ключа доступа (access_token), ключа обновления (refresh_token) и срока действия ключа доступа (auth_access_token_expires). Заменить ими значения соответствующих переменных в строках 233-235. Для этого:
   1) аналогично предыдущему шагу, найти любой из запросов GetMap. В Разделе Request Headers будет Cookie. Из него и надо взять значения. access_token - это параметр authAccessToken, refresh_token - это параметр authRefreshToken, auth_access_token_expires - это параметр authAccessTokenExpires. Пример cookie:
   ```
   _ym_uid=1756110247627323266; _ym_d=1756110247; _ym_isad=1;authAccessToken=eyJhbGci<тут длинющая строка>; authAccessTokenExpires=%222025-08-25T10%3A01%3A11.688Z%22;authRefreshToken=c7M8ixRGrknyW4xuDAkcQxRdWbhluEvR6Qf7Ki70aL2ALxLyaJqfj0p3knOQOqu4o7w1ZZeAQRNQrafJy5
   ```
   Здесь: 
   ```
   access_token = 'eyJhbGci<тут длинющая строка>'
   refresh_token = 'c7M8ixRGrknyW4xuDAkcQxRdWbhluEvR6Qf7Ki70aL2ALxLyaJqfj0'
   auth_access_token_expires = '%222025-08-25T10%3A01%3A11.688Z%22'
   ```
5) Определить все входные параметры для функции download_nspd_layer в строке 252. В этой строке функция вызывается так, чтобы перебирать по очереди слои из списка nspd_layers, и скачивать какие-то из них (уловие в строке 251). Вы можете убрать цикл (строка 250) и условие (сторка 251), и вызывать функцию как угодно. Главное - задать все параметры. Информация о параметрах есть в Docstring:
   1. nspd_layer (str, optional): идентификатор слоя на сервере nspd.gov.ru/map. Соответствует отдельному WMS. 
   Чтобы узнать идентификатор нужного вам слоя, включите его на карте, найдите соответствующий запрос GetMap в Devtools/Network. 
   Идентификатор вшит в URL запроса. Defaults to '36281'.
   2. layer_alias (str, optional): любое краткое название слоя. Будет использовано как имя файла результата. Defaults to 'result'.
   3. tiles_gpkg (str, optional): Относительный путь к Geopackage со слоем тайлов. Defaults to 'tiles.gpkg'.
   4. tiles_layer (str, optional): Слой с тайлами. Тайлы можно создать в QGIS инструментом Create grid. 
   Рекомендуемый размер тайлов 78271.517000 x 78271.517000 м. Проекция EPSG:3857. Defaults to 'khmao'.
   5. width (int, optional): Ширина тайла в пикселах. Рекомендуется 128. Протестировано 512 и 256. Defaults to 128.
   6. height (int, optional): Высота тайла в пикселах. Рекомендуется 128. Протестировано 512 и 256. Defaults to 128.
   7. i_from (int, optional): Начало отсчета столбцов пикселов. Defaults to 0.
   8. i_to (int, optional): Конец отсчета столбцов пикселов. Не может быть больше чем ширина тайла. Defaults to 128.
   9. j_from (int, optional): Начало отсчета строк пикселов. Defaults to 0.
   10. j_to (int, optional): Конец отсчета строк пикселов. Не может быть больше чем высота тайла. Defaults to 128.
   11. pixel_step (int, optional): Шаг перебора пикселов. Может быть от 1 до любого значения (не больше минимального из ширины/высоты). 
   Это промежуток, через который будет выполняться запрос GetFeatureInfo в пикселе. Если 1, то запрос будет в каждом пикселе.
   Общее количество запросов обратно пропорционально квадрату этого шага. Для среднестатистического региона РФ нет смысла брать меньше 3,
   т.к. иначе парсинг выпоняется очень долго. Для больших регионов, как ХМАО, протестирован шаг 9. Defaults to 3.
   12. access_token (str, optional): Ключ безопасности, первоначальное згачение. Чтобы его получить, нужно в Google Chrome зайти на сайт 
   https://nspd.gov.ru/map, залогиниться через Госуслуги (часть слоев на карте доступны и без логина. Если нужны эти слои, то логиниться не обязательно). 
   Затем включить devtools (F12), перейти в раздел Network. 
   На странице включить любой тематический слой. После этого в devtools найти любой запрос GetMap. 
   В нем есть Cookie, из которого надо скопировать authAccessToken.
   13. refresh_token (str, optional): Ключ обновления ключа безопасности, первоначальное значение. Получать аналогично access_token,
   но взять параметр authRefreshToken. Defaults to ''.
   14. auth_access_token_expires (str, optional): срок истечения ключа безопасности, первоначальное значение. Получать аналогично access_token,
   но взять параметр authAccessTokenExpires. Пример - %222025-08-24T06%3A16%3A00.521Z%22. Defaults to ''.
   15. pause (int, optional): пауза между запросами GetFeatureInfo, чтобы снизить риск обвинений в атаке. Defaults to 0.
6.  Запустить скрипт (Ctrl+F5). Будет отображаться прогресс-бар по перебору тайлов в tiles_layer. 
7.  После успешного завершения загрузки в папке results появится файл <tiles_layer>_<layer_alias>.json. Формат - GeoJSON, Проекция - EPSG:3857. Для корректного отображения в ГИС у слоя нужно вручную указать проекцию. 
8.  При ошибке обновления токена будет возбуждено исключение "Не удалось обновить токен. Результат запроса: ..." Если очередной запрос GetFeatureInfo выполняется со статусом отличным от 200, то данная точка просто пропускается и ничего не происходит.